generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  password  String?
  firstName String?
  lastName  String?
  isActive  Boolean @default(true)
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userRoles UserRole[]
  sessions  Session[]
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model Company {
  id          String  @id @default(cuid())
  name        String  @unique
  email       String? @unique
  description String?
  phone       String?
  website     String?
  address     String?
  city        String?
  country     String?
  isActive    Boolean @default(true)

  users          User[]
  roles          Role[]
  sessions       Session[]
  erpConnections ERPConnection[]
  mappingConfigs MappingConfig[]
  auditLogs      AuditLog[]

  warehouses      Warehouse[]
  inventoryCounts InventoryCount[]
  varianceReports VarianceReport[]
  adjustments     InventoryAdjustment[]
  syncHistory     InventorySyncHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id          String  @id @default(cuid())
  name        String
  description String?
  isActive    Boolean @default(true)
  companyId   String
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
  @@index([companyId])
}

model Permission {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  category    String

  rolePermissions RolePermission[]

  createdAt DateTime @default(now())
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
}

model ERPConnection {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  erpType  String // MSSQL, SAP, ORACLE
  host     String
  port     Int
  database String
  username String
  password String // Should be encrypted in production
  isActive Boolean @default(true)

  mappingConfigs MappingConfig[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, erpType])
  @@index([companyId])
}

model MappingConfig {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  erpConnectionId String
  erpConnection   ERPConnection @relation(fields: [erpConnectionId], references: [id], onDelete: Cascade)

  datasetType   String // ITEMS, STOCK, COST, PRICE, DESTINATION
  sourceTables  String[] // JSON array stored as text
  sourceQuery   String?
  fieldMappings Json // Array of { sourceField, targetField, dataType, transformation? }
  filters       Json? // { fieldName: value }

  version  Int     @default(1)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, datasetType, version])
  @@index([companyId])
  @@index([erpConnectionId])
}

model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userAgent      String?
  ipAddress      String?
  isActive       Boolean  @default(true)
  lastActivityAt DateTime @updatedAt

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
}

model AuditLog {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action     String // CREATE, UPDATE, DELETE, VIEW
  resource   String // Users, MappingConfig, ERPConnection
  resourceId String

  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════
// INVENTORY MODULES
// ═══════════════════════════════════════════════════════════════

model Warehouse {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  code     String // Código único del almacén
  name     String // Nombre del almacén
  address  String?
  city     String?
  manager  String? // Encargado del almacén
  isActive Boolean @default(true)

  locations       Warehouse_Location[]
  inventoryCounts InventoryCount[]
  adjustments     InventoryAdjustment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@index([companyId])
}

model Warehouse_Location {
  id          String    @id @default(cuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  code        String // A-01-01 (Aisle-Rack-Shelf)
  description String?
  capacity    Int? // Capacidad máxima
  isActive    Boolean @default(true)

  countItems      InventoryCount_Item[]
  inventoryCounts InventoryCount[]      @relation("InventoryCountToLocation")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([warehouseId, code])
  @@index([warehouseId])
}

model InventoryCount {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  locationId String?
  location   Warehouse_Location? @relation("InventoryCountToLocation", fields: [locationId], references: [id], onDelete: SetNull)

  code        String // INV-2026-02-001
  sequenceNumber String @unique @map("sequenceNumber_idx") // CONT-2026-001 (auto-generado)
  description String?

  status String @default("DRAFT") // DRAFT, ACTIVE, ON_HOLD, COMPLETED, CLOSED, CANCELLED

  // Versionado de conteos
  currentVersion Int @default(1) // Versión activa actual
  totalVersions  Int @default(1) // Total de versiones creadas

  // Auditoría de inicio/pausa/reanudación
  createdBy String @default("system") // Quién creó el conteo
  startedBy String?
  startedAt DateTime @default(now())

  completedBy String?
  completedAt DateTime?

  closedBy String?
  closedAt DateTime?

  approvedBy String?
  approvedAt DateTime?

  // Observaciones
  notes String?

  countItems  InventoryCount_Item[]
  variances   VarianceReport[]
  syncHistory InventorySyncHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@unique([sequenceNumber], map: "InventoryCount_sequenceNumber_unique")
  @@index([companyId])
  @@index([warehouseId])
  @@index([locationId])
  @@index([status])
  @@index([status, warehouseId], map: "InventoryCount_status_warehouse")
}

model InventoryCount_Item {
  id      String         @id @default(cuid())
  countId String
  count   InventoryCount @relation(fields: [countId], references: [id], onDelete: Cascade)

  locationId String
  location   Warehouse_Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // Datos del artículo (desde Catelli)
  itemCode String // SKU/Código
  itemName String // Descripción

  // Códigos de barra (para QR mobile)
  barCodeInv String? // Código de barra inventario (para lectura en almacén)
  barCodeVt String?  // Código de barra venta (para auditoría)

  // Clasificación del artículo
  category String?    // Categoría (ej: "Electrónica", "Ropa")
  brand String?       // Marca del producto
  subcategory String? // Subcategoría (ej: "Accesorios", "Componentes")

  // Unidad de Medida (del empaque)
  packQty Decimal @default(1) // Cantidad por empaque (ej: 12 docena)
  uom     String // Unidad (ej: "Cajas", "Pz", "KG", "LT")
  baseUom String  @default("PZ") // Unidad base para conversión

  // Cantidades por versión
  systemQty  Decimal // Cantidad en sistema (desde ERP) - No cambia
  countedQty Decimal? // Cantidad contada
  version    Int @default(1) // Número de versión del conteo

  // Estado del item
  status String @default("PENDING") // PENDING, APPROVED, VARIANCE
  hasVariance Boolean @default(false) // true si countedQty != systemQty

  // Precios (para auditoría de valor)
  costPrice Decimal?
  salePrice Decimal?

  // Auditoría
  notes     String?
  countedBy String?
  countedAt DateTime @default(now())

  // Relación con varianzas (1:Many porque puede haber una por versión)
  variance_reports VarianceReport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([countId, locationId, itemCode, version])
  @@index([countId])
  @@index([locationId])
  @@index([itemCode])
  @@index([countId, version])
}

model VarianceReport {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  countId String
  count   InventoryCount @relation(fields: [countId], references: [id], onDelete: Cascade)

  countItemId String
  countItem   InventoryCount_Item @relation(fields: [countItemId], references: [id], onDelete: Cascade)

  // Versión de este reporte
  version Int @default(1) // V1, V2, V3, etc.

  itemCode String
  itemName String?

  systemQty       Decimal
  countedQty      Decimal // Cantidad de esta versión específica
  difference      Decimal // countedQty - systemQty
  variancePercent Decimal // (difference / systemQty) * 100

  status     String  @default("PENDING") // PENDING, APPROVED, REJECTED, ADJUSTED
  reason     String? // Motivo de la varianza
  resolution String? // Resolución aplicada

  approvedBy String?
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([countId, countItemId, version])
  @@index([companyId])
  @@index([countId])
  @@index([version])
  @@index([status])
}

model InventoryAdjustment {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  code        String // ADJ-2026-02-001
  description String?

  type String // VARIANCE_CORRECTION, PHYSICAL_LOSS, GAIN, TRANSFER

  items Json // Array de { itemCode, quantity, reason }

  createdBy String?
  createdAt DateTime @default(now())

  approvedBy String?
  approvedAt DateTime?

  status String @default("PENDING") // PENDING, APPROVED, REJECTED

  @@unique([companyId, code])
  @@index([companyId])
  @@index([warehouseId])
  @@index([status])
}

model InventorySyncHistory {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  countId String
  count   InventoryCount @relation(fields: [countId], references: [id], onDelete: Cascade)

  status   String // COMPLETED, PARTIAL, FAILED
  strategy String // REPLACE, ADD (update strategy used)

  itemsSynced Int // Items successfully synced
  itemsFailed Int // Items that failed
  totalItems  Int // Total items attempted

  details String // JSON with detailed sync results for each item

  syncedBy String? // User who triggered sync
  syncedAt DateTime @default(now())
  duration Int // Duration in milliseconds

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([countId])
  @@index([status])
  @@index([syncedAt])
}
