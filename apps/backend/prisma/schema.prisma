generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String?
  firstName      String?
  lastName       String?
  isActive       Boolean         @default(true)
  companyId      String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  aiChatMessages AIChatMessage[]
  auditLogs      AuditLog[]
  sessions       Session[]
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userRoles      UserRole[]

  @@index([companyId])
}

model Company {
  id              String                 @id @default(cuid())
  name            String                 @unique
  email           String?                @unique
  description     String?
  phone           String?
  website         String?
  address         String?
  city            String?
  country         String?
  isActive        Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  aiChatMessages  AIChatMessage[]
  aiConfigs       AIConfig[]
  auditLogs       AuditLog[]
  erpConnections  ERPConnection[]
  adjustments     InventoryAdjustment[]
  inventoryCounts InventoryCount[]
  syncHistory     InventorySyncHistory[]
  classifications ItemClassification[]
  mappingConfigs  MappingConfig[]
  roles           Role[]
  sessions        Session[]
  users           User[]
  varianceReports VarianceReport[]
  warehouses      Warehouse[]
}

model Role {
  id              String           @id @default(cuid())
  name            String
  description     String?
  isActive        Boolean          @default(true)
  companyId       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([companyId, name])
  @@index([companyId])
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  category        String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
}

model ERPConnection {
  id             String          @id @default(cuid())
  companyId      String
  erpType        String
  host           String
  port           Int
  database       String
  username       String
  password       String
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  mappingConfigs MappingConfig[]

  @@unique([companyId, erpType])
  @@index([companyId])
}

model MappingConfig {
  id              String        @id @default(cuid())
  companyId       String
  erpConnectionId String
  datasetType     String
  sourceTables    String[]
  sourceQuery     String?
  fieldMappings   Json
  filters         Json?
  version         Int           @default(1)
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  erpConnection   ERPConnection @relation(fields: [erpConnectionId], references: [id], onDelete: Cascade)

  @@unique([companyId, datasetType, version])
  @@index([companyId])
  @@index([erpConnectionId])
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  companyId      String
  userAgent      String?
  ipAddress      String?
  isActive       Boolean  @default(true)
  lastActivityAt DateTime @updatedAt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  companyId  String
  userId     String?
  action     String
  resource   String
  resourceId String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
}

model Warehouse {
  id              String                @id @default(cuid())
  companyId       String
  code            String
  name            String
  address         String?
  city            String?
  manager         String?
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  adjustments     InventoryAdjustment[]
  inventoryCounts InventoryCount[]
  company         Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  locations       Warehouse_Location[]

  @@unique([companyId, code])
  @@index([companyId])
}

model Warehouse_Location {
  id              String                @id @default(cuid())
  warehouseId     String
  code            String
  description     String?
  capacity        Int?
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  inventoryCounts InventoryCount[]      @relation("InventoryCountToLocation")
  countItems      InventoryCount_Item[]
  warehouse       Warehouse             @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, code])
  @@index([warehouseId])
}

model InventoryCount {
  id             String                 @id @default(cuid())
  companyId      String
  warehouseId    String
  locationId     String?
  code           String
  sequenceNumber String                 @unique @map("sequenceNumber_idx")
  description    String?
  status         String                 @default("DRAFT")
  currentVersion Int                    @default(1)
  totalVersions  Int                    @default(1)
  createdBy      String                 @default("system")
  startedBy      String?
  startedAt      DateTime               @default(now())
  completedBy    String?
  completedAt    DateTime?
  closedBy       String?
  closedAt       DateTime?
  approvedBy     String?
  approvedAt     DateTime?
  notes          String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  company        Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  location       Warehouse_Location?    @relation("InventoryCountToLocation", fields: [locationId], references: [id])
  warehouse      Warehouse              @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  countItems     InventoryCount_Item[]
  syncHistory    InventorySyncHistory[]
  variances      VarianceReport[]

  @@unique([companyId, code])
  @@index([companyId])
  @@index([warehouseId])
  @@index([locationId])
  @@index([status])
  @@index([status, warehouseId], map: "InventoryCount_status_warehouse")
}

model InventoryCount_Item {
  id               String             @id @default(cuid())
  countId          String
  locationId       String
  itemCode         String
  itemName         String
  barCodeInv       String?
  barCodeVt        String?
  category         String?
  brand            String?
  subcategory      String?
  packQty          Decimal            @default(1)
  uom              String
  baseUom          String             @default("PZ")
  systemQty        Decimal
  countedQty       Decimal?
  version          Int                @default(1)
  status           String             @default("PENDING")
  hasVariance      Boolean            @default(false)
  costPrice        Decimal?
  salePrice        Decimal?
  notes            String?
  countedBy        String?
  countedAt        DateTime?          @default(now())
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  count            InventoryCount     @relation(fields: [countId], references: [id], onDelete: Cascade)
  location         Warehouse_Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  variance_reports VarianceReport[]

  @@unique([countId, locationId, itemCode, version])
  @@index([countId])
  @@index([locationId])
  @@index([itemCode])
  @@index([countId, version])
}

model VarianceReport {
  id              String              @id @default(cuid())
  companyId       String
  countId         String
  countItemId     String
  version         Int                 @default(1)
  itemCode        String
  itemName        String?
  systemQty       Decimal
  countedQty      Decimal
  difference      Decimal
  variancePercent Decimal
  status          String              @default("PENDING")
  reason          String?
  resolution      String?
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  count           InventoryCount      @relation(fields: [countId], references: [id], onDelete: Cascade)
  countItem       InventoryCount_Item @relation(fields: [countItemId], references: [id], onDelete: Cascade)

  @@unique([countId, countItemId, version])
  @@index([companyId])
  @@index([countId])
  @@index([version])
  @@index([status])
}

model InventoryAdjustment {
  id          String    @id @default(cuid())
  companyId   String
  warehouseId String
  code        String
  description String?
  type        String
  items       Json
  createdBy   String?
  createdAt   DateTime  @default(now())
  approvedBy  String?
  approvedAt  DateTime?
  status      String    @default("PENDING")
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId])
  @@index([warehouseId])
  @@index([status])
}

model InventorySyncHistory {
  id          String         @id @default(cuid())
  companyId   String
  countId     String
  status      String
  strategy    String
  itemsSynced Int
  itemsFailed Int
  totalItems  Int
  details     String
  syncedBy    String?
  syncedAt    DateTime       @default(now())
  duration    Int
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  company     Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  count       InventoryCount @relation(fields: [countId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([countId])
  @@index([status])
  @@index([syncedAt])
}

model ItemClassification {
  id          String                  @id @default(cuid())
  code        String
  description String
  groupType   ItemClassificationGroup
  groupNumber Int
  isActive    Boolean                 @default(true)
  companyId   String
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  company     Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId])
  @@index([companyId, groupType])
}

model AIConfig {
  id           String   @id @default(cuid())
  companyId    String
  provider     String   @default("OPENAI")
  apiKey       String?
  modelName    String?  @default("gpt-4")
  baseUrl      String?
  systemPrompt String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, provider])
  @@index([companyId])
}

model AIChatMessage {
  id        String   @id @default(cuid())
  companyId String
  userId    String
  role      String
  content   String
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, userId])
}

enum ItemClassificationGroup {
  CATEGORY
  SUBCATEGORY
  BRAND
  OTHER
}
